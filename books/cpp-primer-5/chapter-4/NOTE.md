第 4 章   表达式
=========

[TOC]

表达式由一个或多个**运算对象**（operand）组成，对表达式求值将得到一个**结果**（result）。字面值和变量是最简单的**表达式**（expression），其结果就是字面值和变量的值。把一个**运算符**（operator）和一个或多个运算对象组合起来可以生成复杂的表达式。

# 4.1 基础

## 4.1.1 基本概念

C\+\+定义了一元运算符（unary operator）和二元运算符（binary operator）。  

- 一元运算符：`&`，`*`（解引用），`-`（负号），`+`（正号）
- 二元运算符：`+`，`-`，`*`（乘法），`/`，`%`，`==`，`!=`
- 三元运算符：`? :`
- 函数调用也是一种特殊的运算符，它对运算对象的数量没有限制  

组合运算时需要考虑运算符的*优先级*（precedence），*结合律*（associativity）以及运算对象的*求值顺序*（order of evaluation）。

同时需要注意求值过程中对象的转换。小整数类型（如`bool`，`char`，`short`）通常会被**提升**（promoted）成较大的整数类型（如`int`）。

C\+\+语言定义了运算符作用于内置类型和复合类型的运算对象时所执行的操作，用户可以自定义其行为，叫**运算符重载**（overloaded operator）。

运算符重载可以定义运算对象的类型和返回值类型，但是**运算对象的个数、运算符优先级和结合律都是无法改变的**。



### 左值和右值

C\+\+表达式要不然是**右值**（rvalue），要不然是**左值**（lvalue）。从C语言继承，在C语言原本含义为：左值可以位于赋值语句的左侧，右值则不能。

在C\+\+里含义比较复杂，可以归纳为：**当一个对象被用作右值的时候，用的是对象的值（内容）；当对象被用作左值的时候，用的是对象的身份（在内存的位置）**。

不同运算符对运算对象的要求不同，有些需要左值运算对象，有些需要右值。当前总结如下：

- 赋值运算符需要一个（非常量）左值作为其左侧运算对象，得到的结果也仍然是一个左值。
- 取地址符作用于一个左值运算对象，返回一个指向该运算对象的地址，这个指针是一个右值。  
- 内置解引用运算符、下标运算符、迭代器解引用运算符、`string`和`vector`的下标运算符的求值结果都是左值。  
- 内置类型和迭代器的递增递减运算符（`++i`，`--i`）作用于左值运算对象，其前置版本（`i++）`）所得的结果也是左值。

`decltype`关键字对于左值右值也有不同：  

- 表达式的求值结果是左值，则`decltype`作用于该表达式（不是变量）得到一个引用类型  
- 如果是右值，例如 `decltype(&p)`，其中`p`是一个指针，则返回的是`int **`，指向指针的指针  



## 4.1.2 优先级和结合律

运算符计算步骤：  

1. 先看括号内计算，括号无视优先级和结合律
2. 再考虑优先级，优先级高的先计算
3. 然后考虑结合律，C\+\+算术运算符满足**左结合律**，即如果优先级相同，则是从左到右结合计算  



## 4.1.3 求值顺序

优先级规定了运算符的组合方式，但是没有说明运算符对象按照什么顺序求值。所以对于下面几个运算不能明确谁先被调用：  

```cpp
int i = f1() + f2();   // 虽然可以确定f1(), f2()会在 + 运算之前调用，但是它们两者却不知道谁先被调用

int i = 0;
cout << i << " " << ++i << endl;  // 未定义的，因为不能确定是先求i的值还是先计算 ++i
```

有4中运算符是明确规定运算对象的求值顺序：  

- `&&`逻辑与运算符，规定先求左侧运算符，只有左侧运算对象的值为真才继续求右侧运算对象的值  
- `||`逻辑或  
- `? :`条件运算符
- `,`逗号运算符

### 求值顺序、优先级、结合律

运算对象的求值顺序与优先级和结合律无关。  

处理复合表达式时最好遵循以下两条经验 ：

1. 拿不准的时候最好用括号来强制让表达式的组合关系符合程序逻辑的要求。
2. 如果改变了某个运算对象的值，在表达式的其他地方不要在使用这个运算对象。

第2条有一个重要的例外，当改变运算对象的子表达式本身就是另一个子表达式的运算对象时，改规则无效。譬如在表达式`* ++iter`中，递增运算符先改变`iter`的值，`iter`的值（已改变）又是解引用运算符的运算对象。

*在Java中，求值顺序是规定的，都是从左到右计算*。可以看[cnblogs - Java运算顺序的深入解析](http://www.cnblogs.com/jinggod/p/8424880.html)。

参考：[CSDN - C\+\+ - 表达式求值顺序](https://blog.csdn.net/fefe82/article/details/37833767)



# 4.2 算术运算符

按照优先级排序：  

1. `+`一元正号，`-`一元负号
2. `*`乘法，`/`除法，`%`求余
3. `+`加法，`-`减法

上述运算符都满足**左结合律**，即当运算符优先级相同时按照从左到右的顺序进行组合。

如无特殊说明，算术运算符都能用作任意算数类型或能转换成算数类型的类型。算术运算符的运算对象和求值结果都是**右值**。算术表达式在求值之前会做类型提升，保证运算对象类型最终都会是同一类型。

- 一元正号、加法运算符和减法运算符都能应用于指针。当一元正号作用于指针或算术值时，返回运算对象值的一个（提升后）副本。
- 一元负号运算符对运算对象值取负后，返回其（提升后的）副本。

布尔值不应参与运算，因为：

```cpp
bool b = true;
int r = 1 + (-b); // b会提升为int，因为true对应1，所以(-b)就是-1，则r的值为0
bool b2 = -b; // 同理，-b的结果是-1，对于非0数值转成bool都是true，所以b2仍然为true
```

**整数相除**：结果仍然是整数，会直接弃除小数部分。在C\+\+11之前允许结果为负值的商向上或向下取整，但是在C\+\+11规定**除法的商一律向0取整（即直接切除小数部分）**。

**取余运算**：参与取余运算的运算对象**必须是整数类型**。新标准规定除了`-m`导致溢出的特殊情况，`(-m)/n`和`m/(-n)  `都等同于`-(m/n)`，`m%(-n)`等于`m%n`，`(-m)%n`等于`-(m%n)`。



# 4.3 逻辑和关系运算符

- 关系运算符作用于算术类型或指针类型  
- 逻辑运算符作用于任意能转换成布尔值的类型

关系运算符和逻辑运算符的返回值都是布尔类型。值为0的运算对象（算术类型或指针类型）表示假，否则表示真。**对于两种运算符来说，运算对象和求值结果都是右值**。

除了逻辑非`!`是右结合律，其他逻辑运算符和所有关系运算符都是左结合律。

### 逻辑与和逻辑或运算符

两者都会**短路求值**，并且都要求左侧运算对象先求值。

### 逻辑非运算符

将运算对象的值取反后返回。

### 关系运算符

关系运算符比较运算对象的大小关系并且返回布尔值。关系运算符都满足左结合律。

进行比较运算时除非比较的对象是布尔类型，否则不要使用布尔字面值`true`和`false`作为运算对象，因为会自动转换成比较类型。



# 4.4 赋值运算符

赋值运算符的左侧运算对象必须是一个可修改的左值。赋值运算的结果是它左侧运算对象，并且是一个左值。